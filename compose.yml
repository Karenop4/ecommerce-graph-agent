services:
  # --- SERVICIO 1: BASE DE DATOS ---
  neo4j:
    image: neo4j:5.15.0
    container_name: neo4j_db
    ports:
      - "7474:7474" # HTTP
      - "7687:7687" # Bolt
    environment:
      - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
    volumes:
      - neo4j_data_vol:/data

  # --- REDIS (estado conversacional) ---
  redis:
    image: redis:7
    container_name: redis_state
    ports:
      - "6380:6379"
    # opcional: persistencia (si quieres que no se borre al reiniciar)
    volumes:
      - ./redis_data:/data
    command: ["redis-server", "--appendonly", "yes"]

  # --- SERVICIO 2: BACKEND (API) ---
  backend:
    build: ./app
    container_name: backend_agente
    ports:
      - "8000:8000"
    env_file: .env
    environment:
      - PYTHONUNBUFFERED=1
      - NEO4J_URI=bolt://neo4j:7687
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - REDIS_URL=redis://redis:6379/0
      - REDIS_TTL_SECONDS=86400
    depends_on:
      - neo4j
      - redis
      - mlflow
    volumes:
      - ./app:/app

  # --- SERVICIO 3: FRONTEND (REACT) ---
  frontend:
    build: ./frontend-agente
    container_name: frontend_agente
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://localhost:8000
    depends_on:
      - backend
    volumes:
      - ./frontend-agente:/app
      - /app/node_modules

  # --- 4. MLFLOW ---
  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.10.0
    container_name: mlflow_server
    ports:
      - "5000:5000"
    volumes:
      - ./mlflow_db:/mlflow_store
      - ./mlflow_artifacts:/mlflow_artifacts
    environment:
      - SERVER_PORT=5000
      - SERVER_HOST=0.0.0.0
    command: >
      mlflow server
      --backend-store-uri sqlite:////mlflow_store/mlflow.db
      --default-artifact-root /mlflow_artifacts
      --host 0.0.0.0
      --port 5000

volumes:
  neo4j_data_vol:
    external: true
